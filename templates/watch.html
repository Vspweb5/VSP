{% extends 'base.html' %}
{% block title %}
VSP | Video Title
{% endblock title %}

{% block link %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/watch.css') }}" />
{% endblock link %}

{% block script %}
<!-- <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase.js"></script>
<script src="{{url_for('static', filename='js/videos.js')}}"></script> -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCV5Ve41CZI5b2j9dexFqQjwH9pdvur5KY",
        authDomain: "vsp-web.firebaseapp.com",
        databaseURL: "https://vsp-web-default-rtdb.firebaseio.com",
        projectId: "vsp-web",
        storageBucket: "vsp-web.appspot.com",
        messagingSenderId: "76950228191",
        appId: "1:76950228191:web:c83ad1d27d8c333961ed6a",
        measurementId: "G-FH6MYLQEC4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase();
    const dbRef = ref(db, '/users/');
    const uKey = '-' + document.getElementById("key").innerText;
    const vid = document.getElementById("uVideo");
    const tube = document.getElementById("uTube");
    let flag = 1;
    var utitle = document.getElementById("utitle");
    var udesc = document.getElementById("udesc");
    var url = null;
    var vidLink;
    var tubeLink;

    onValue(dbRef, (snapshot) => {
        snapshot.forEach(user => {
            user.forEach(snap => {
                if (snap.key == "videos") {
                    snap.forEach(video => {
                        if (video.key == uKey) {
                            // console.log("Match Found");
                            flag = 0;
                            video.forEach(content => {
                                if (content.key == "title") {
                                    utitle.innerText = content.val();
                                }
                                if (content.key == "desc") {
                                    udesc.innerText = content.val();
                                }
                                if (content.key == "fileURL") {
                                    url = content.val();
                                    if (url.includes("-")) {
                                        // vid.autofocus = 'true';
                                        vidLink = "https://firebasestorage.googleapis.com/v0/b/vsp-web.appspot.com/o/videos%2F" + url + ".mp4?alt=media";
                                        vid.setAttribute("src", vidLink);
                                    }
                                    else {
                                        // tube.autofocus = 'true';
                                        tube.style.display = "block";
                                        vid.style.display = "none";
                                        tubeLink = "https://www.youtube.com/embed/" + url + "?autoplay=1&rel=0";
                                        tube.setAttribute("src", tubeLink);
                                    }
                                }
                            });
                        }
                    });
                    if (flag) {
                        alert("Video Not Available.");
                    }
                }
            });
        });
    });
</script>
{% endblock script %}

{% block body %}
<!-- <h1>Watch a video</h1> -->
<div id="key" style="display: none;">{{key}}</div>
<div class="container play-container">
    <div class="row">
        <div class="play-video">
            <video controls autoplay style="display: block" id="uVideo" src="" type="video/mp4">
            </video>
            <iframe width="100%" height="auto" id="uTube" src="" style="display: none" title="YouTube video player"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
            <h3 class="title" id="utitle"></h3>
        </div>
    </div>
    <div class="button">
        <button class="Overview"><a href="">Overview</a></button>
        <button class="s2"><a href="">Q&A</a></button>
        <button class="Share"><a href=""></a><a href="">Share</a></button>
        <hr>
    </div>
    <div class="desc" id="udesc"></div>
</div>
{% endblock body %}